{% extends "base.html" %}

{% block title %}{{ character.name }} - Character Details{% endblock %}

{% block content %}
<div class="container">
    <!-- Character Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="mb-0">{{ character.name }}</h1>
            <p class="text-muted">
                {{ character.rank }} {{ character.race }} - {{ character.concept }}
            </p>
        </div>
        <div>
            <a href="{{ url_for('view_characters') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Characters
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Left Column -->
        <div class="col-md-4">
            <!-- Attributes Card -->
            <div class="card bg-secondary mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Attributes</h5>
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-4">
                            <div class="p-2 border rounded text-center">
                                <small>AGI</small>
                                <h5 class="mb-0">{{ character.agility }}</h5>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 border rounded text-center">
                                <small>SMA</small>
                                <h5 class="mb-0">{{ character.smarts }}</h5>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 border rounded text-center">
                                <small>SPI</small>
                                <h5 class="mb-0">{{ character.spirit }}</h5>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 border rounded text-center">
                                <small>STR</small>
                                <h5 class="mb-0">{{ character.strength }}</h5>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 border rounded text-center">
                                <small>VIG</small>
                                <h5 class="mb-0">{{ character.vigor }}</h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Derived Stats Card -->
            <div class="card bg-secondary mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Derived Stats</h5>
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-6">
                            <div class="p-2 border rounded text-center">
                                <small>Pace</small>
                                <h5 class="mb-0">{{ character.pace }}</h5>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-2 border rounded text-center">
                                <small>Parry</small>
                                <h5 class="mb-0">{{ character.parry }}</h5>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-2 border rounded text-center">
                                <small>Toughness</small>
                                <h5 class="mb-0">{{ character.toughness }}</h5>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-2 border rounded text-center">
                                <small>Charisma</small>
                                <h5 class="mb-0">{{ character.charisma }}</h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Card -->
            <div class="card bg-secondary mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Status</h5>
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-4">
                            <div class="p-2 border rounded text-center">
                                <small>Wounds</small>
                                <h5 class="mb-0">{{ character.wounds }}/3</h5>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 border rounded text-center">
                                <small>Fatigue</small>
                                <h5 class="mb-0">{{ character.fatigue }}/2</h5>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 border rounded text-center">
                                <small>Bennies</small>
                                <h5 class="mb-0">{{ character.bennies }}/3</h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="col-md-8">
            <!-- Tabs Navigation -->
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#skills">Skills</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#edges">Edges & Hindrances</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#powers">Powers</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#inventory">Inventory</a>
                </li>
            </ul>

            <!-- Tabs Content -->
            <div class="tab-content mt-3">
                <!-- Skills Tab -->
                <div class="tab-pane fade show active" id="skills">
                    <div class="card bg-secondary">
                        <div class="card-body">
                            <h5>Core Skills</h5>
                            <p>{{ character.core_skills|replace('\n', '<br>')|safe }}</p>
                            
                            <h5 class="mt-4">Knowledge Skills</h5>
                            <p>{{ character.knowledge_skills|replace('\n', '<br>')|safe }}</p>
                        </div>
                    </div>
                </div>

                <!-- Edges & Hindrances Tab -->
                <div class="tab-pane fade" id="edges">
                    <div class="card bg-secondary">
                        <div class="card-body">
                            <h5>Edges</h5>
                            <p>{{ character.edges|replace('\n', '<br>')|safe }}</p>
                            
                            <h5 class="mt-4">Hindrances</h5>
                            <p>{{ character.hindrances|replace('\n', '<br>')|safe }}</p>
                        </div>
                    </div>
                </div>

                <!-- Powers Tab -->
                <div class="tab-pane fade" id="powers">
                    <div class="card bg-secondary">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">Powers</h5>
                                <span class="badge bg-primary">Power Points: {{ character.power_points }}</span>
                            </div>
                            <p>{{ character.powers|replace('\n', '<br>')|safe }}</p>
                        </div>
                    </div>
                </div>

                <!-- Inventory Tab -->
                <div class="tab-pane fade" id="inventory">
                    <div class="card bg-secondary">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">Inventory</h5>
                                <div>
                                    <span class="badge bg-info me-2">Money: ${{ character.money }}</span>
                                    <span class="badge bg-info">Weight: <span id="totalWeight">0</span></span>
                                    <button class="btn btn-sm btn-primary ms-2" data-bs-toggle="modal" data-bs-target="#addItemModal">
                                        <i class="fas fa-plus"></i> Add Item
                                    </button>
                                </div>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-dark">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Type</th>
                                            <th>Quantity</th>
                                            <th>Weight</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="inventoryTableBody">
                                        <!-- Inventory items will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Item Modal -->
<div class="modal fade" id="addItemModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-secondary">
            <div class="modal-header">
                <h5 class="modal-title">Add Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addItemForm">
                    <div class="mb-3">
                        <label for="itemName" class="form-label">Item Name</label>
                        <input type="text" class="form-control" id="itemName" required>
                    </div>
                    <div class="mb-3">
                        <label for="itemType" class="form-label">Item Type</label>
                        <select class="form-select" id="itemType" required>
                            <option value="Weapon">Weapon</option>
                            <option value="Armor">Armor</option>
                            <option value="Shield">Shield</option>
                            <option value="Gear">Gear</option>
                            <option value="Tool">Tool</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="itemQuantity" class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="itemQuantity" value="1" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label for="itemWeight" class="form-label">Weight (lbs)</label>
                        <input type="number" class="form-control" id="itemWeight" value="0" min="0" step="0.1" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="addItem()">Add Item</button>
            </div>
        </div>
    </div>
</div>

<script>
// Get character ID from the current URL
const characterId = {{ character.id }};

// Load inventory when the page loads
document.addEventListener('DOMContentLoaded', function() {
    loadInventory();
    
    // Also load when switching to the inventory tab
    document.querySelector('a[href="#inventory"]').addEventListener('shown.bs.tab', function (e) {
        loadInventory();
    });
});

function loadInventory() {
    fetch(`/character/${characterId}/inventory`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateInventoryTable(data.inventory);
                document.getElementById('totalWeight').textContent = 
                    data.total_weight.toFixed(1) + ' lbs';
            }
        })
        .catch(error => console.error('Error loading inventory:', error));
}

function updateInventoryTable(items) {
    const tbody = document.getElementById('inventoryTableBody');
    tbody.innerHTML = '';
    
    items.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${item.name}</td>
            <td>${item.item_type}</td>
            <td>${item.quantity}</td>
            <td>${(item.weight * item.quantity).toFixed(1)} lbs</td>
            <td>
                <button class="btn btn-sm btn-outline-primary me-1" 
                        onclick="toggleEquipped(${item.id})">
                    ${item.equipped ? 'Unequip' : 'Equip'}
                </button>
                <button class="btn btn-sm btn-outline-danger" 
                        onclick="removeItem(${item.id})">
                    Remove
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function addItem() {
    const form = document.getElementById('addItemForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const data = {
        name: document.getElementById('itemName').value,
        item_type: document.getElementById('itemType').value,
        quantity: parseInt(document.getElementById('itemQuantity').value),
        weight: parseFloat(document.getElementById('itemWeight').value)
    };

    fetch(`/character/${characterId}/inventory/add`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadInventory();
            $('#addItemModal').modal('hide');
            form.reset();
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error adding item');
    });
}

function toggleEquipped(itemId) {
    fetch(`/character/${characterId}/inventory/${itemId}/toggle`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadInventory();
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error toggling item');
    });
}

function removeItem(itemId) {
    if (!confirm('Are you sure you want to remove this item?')) {
        return;
    }

    fetch(`/character/${characterId}/inventory/${itemId}/remove`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadInventory();
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error removing item');
    });
}
</script>
{% endblock %}
